# https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions
name: cpi-cicd-pipeline
on:
  workflow_dispatch:
  push:
    branches:
      - github-actions

jobs:
# Unit test
  unit_test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v3
        with:
          java-version: '8'
          distribution: 'temurin'
      - name: 'Local unit test with Maven'
        run: mvn clean test

# Update designtime
  update:
    runs-on: ubuntu-latest
    needs: unit_test
    container:
      image: engswee/flashpipe:3.0.0
    steps:
      - uses: actions/checkout@v4

      - name: 'Update/Upload Groovy XML Transformation to design time'
        uses: engswee/flashpipe-action/update/artifact@v1
        with:
          tmn-host: equaliseit.it-cpi023.cfapps.eu20-001.hana.ondemand.com
          oauth-host: equaliseit.authentication.eu20.hana.ondemand.com
          oauth-clientid: ${{ secrets.DEV_CLIENT_ID }}
          oauth-clientsecret: ${{ secrets.DEV_CLIENT_SECRET }}
          artifact-id: GroovyXMLTransformation
          artifact-name: Groovy XML Transformation
          package-id: FlashPipeDemo
          package-name: FlashPipe Demo
          dir-artifact-relative: FlashPipe Demo/Groovy XML Transformation
      - name: 'Update/Upload Sample_Message_Mapping to design time'
        uses: engswee/flashpipe-action/update/artifact@v1
        with:
          tmn-host: equaliseit.it-cpi023.cfapps.eu20-001.hana.ondemand.com
          oauth-host: equaliseit.authentication.eu20.hana.ondemand.com
          oauth-clientid: ${{ secrets.DEV_CLIENT_ID }}
          oauth-clientsecret: ${{ secrets.DEV_CLIENT_SECRET }}
          artifact-id: Sample_Message_Mapping
          artifact-name: Sample Message Mapping
          package-id: FlashPipeDemo
          package-name: FlashPipe Demo
          dir-artifact-relative: FlashPipe Demo/Sample_Message_Mapping
          artifact-type: MessageMapping

      - name: 'Update/Upload Sample_Script_Collection to design time'
        uses: engswee/flashpipe-action/update/artifact@v1
        with:
          tmn-host: equaliseit.it-cpi023.cfapps.eu20-001.hana.ondemand.com
          oauth-host: equaliseit.authentication.eu20.hana.ondemand.com
          oauth-clientid: ${{ secrets.DEV_CLIENT_ID }}
          oauth-clientsecret: ${{ secrets.DEV_CLIENT_SECRET }}
          artifact-id: Sample_Script_Collection
          artifact-name: Sample Script Collection
          package-id: FlashPipeDemo
          package-name: FlashPipe Demo
          dir-artifact-relative: FlashPipe Demo/Sample_Script_Collection
          artifact-type: ScriptCollection

      - name: 'Update/Upload Sample_Value_Mapping to design time'
        uses: engswee/flashpipe-action/update/artifact@v1
        with:
          tmn-host: equaliseit.it-cpi023.cfapps.eu20-001.hana.ondemand.com
          oauth-host: equaliseit.authentication.eu20.hana.ondemand.com
          oauth-clientid: ${{ secrets.DEV_CLIENT_ID }}
          oauth-clientsecret: ${{ secrets.DEV_CLIENT_SECRET }}
          artifact-id: Sample_Value_Mapping
          artifact-name: Sample Value Mapping
          package-id: FlashPipeDemo
          package-name: FlashPipe Demo
          dir-artifact-relative: FlashPipe Demo/Sample_Value_Mapping
          artifact-type: ValueMapping

  # Deploy to runtime
  deploy:
    runs-on: ubuntu-latest
    needs: update
    container:
      image: engswee/flashpipe:3.0.0
    steps:
      - uses: actions/checkout@v4

      - name: 'Deploy Groovy XML Transformation to runtime'
        uses: engswee/flashpipe-action/deploy@v1
        with:
          tmn-host: equaliseit.it-cpi023.cfapps.eu20-001.hana.ondemand.com
          oauth-host: equaliseit.authentication.eu20.hana.ondemand.com
          oauth-clientid: ${{ secrets.DEV_CLIENT_ID }}
          oauth-clientsecret: ${{ secrets.DEV_CLIENT_SECRET }}
          artifact-ids: GroovyXMLTransformation

      - name: 'Deploy Sample_Message_Mapping to runtime'
        uses: engswee/flashpipe-action/deploy@v1
        with:
          tmn-host: equaliseit.it-cpi023.cfapps.eu20-001.hana.ondemand.com
          oauth-host: equaliseit.authentication.eu20.hana.ondemand.com
          oauth-clientid: ${{ secrets.DEV_CLIENT_ID }}
          oauth-clientsecret: ${{ secrets.DEV_CLIENT_SECRET }}
          artifact-ids: Sample_Message_Mapping
          artifact-type: MessageMapping

      - name: 'Deploy Sample_Script_Collection to runtime'
        uses: engswee/flashpipe-action/deploy@v1
        with:
          tmn-host: equaliseit.it-cpi023.cfapps.eu20-001.hana.ondemand.com
          oauth-host: equaliseit.authentication.eu20.hana.ondemand.com
          oauth-clientid: ${{ secrets.DEV_CLIENT_ID }}
          oauth-clientsecret: ${{ secrets.DEV_CLIENT_SECRET }}
          artifact-ids: Sample_Script_Collection
          artifact-type: ScriptCollection

      - name: 'Deploy Sample_Value_Mapping to runtime'
        uses: engswee/flashpipe-action/deploy@v1
        with:
          tmn-host: equaliseit.it-cpi023.cfapps.eu20-001.hana.ondemand.com
          oauth-host: equaliseit.authentication.eu20.hana.ondemand.com
          oauth-clientid: ${{ secrets.DEV_CLIENT_ID }}
          oauth-clientsecret: ${{ secrets.DEV_CLIENT_SECRET }}
          artifact-ids: Sample_Value_Mapping
          artifact-type: ValueMapping
