# https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions
name: cpi-cicd-pipeline
on:
  workflow_dispatch:
  push:
    branches:
      - github-actions

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: engswee/flashpipe:2.x.x
    env:
      HOST_TMN: equaliseit.it-cpi005.cfapps.eu20.hana.ondemand.com
      HOST_OAUTH: equaliseit.authentication.eu20.hana.ondemand.com
      OAUTH_CLIENTID: ${{ secrets.DEV_CLIENT_ID }}
      OAUTH_CLIENTSECRET: ${{ secrets.DEV_CLIENT_SECRET }}
    steps:
      - name: 'Checkout Git repository'
        uses: actions/checkout@v2
      - name: 'Local unit test with Maven'
        run: mvn clean test -s /usr/share/maven/ref/settings-docker.xml
      # Set environment variable for source directory of IFlow
      - name: 'Set environment variables for update_designtime_artifact.sh'
        run: |
          echo "GIT_SRC_DIR=$GITHUB_WORKSPACE/FlashPipe Demo/Groovy XML Transformation" >> $GITHUB_ENV
      # Upload/Update design time
      - name: 'Update/Upload Groovy XML Transformation to design time'
        run: /usr/bin/update_designtime_artifact.sh
        shell: bash
        env:
          IFLOW_ID: GroovyXMLTransformation
          IFLOW_NAME: "Groovy XML Transformation"
          PACKAGE_ID: FlashPipeDemo
          PACKAGE_NAME: "FlashPipe Demo"
      # Deploy runtime
      - name: 'Deploy Groovy XML Transformation to runtime'
        run: /usr/bin/deploy_runtime_artifact.sh
        shell: bash
        env:
          IFLOW_ID: GroovyXMLTransformation
          DELAY_LENGTH: 15